using WSantosDev.EventSourcing.Accounts.Commands;
using WSantosDev.EventSourcing.Commons;
using WSantosDev.EventSourcing.Commons.Messaging;

namespace WSantosDev.EventSourcing.Accounts.Test
{
    public sealed class OpenTest : IDisposable
    {
        private readonly Database _database;
        private readonly IMessageBus _messageBus;

        public OpenTest()
        {
            _database = DatabaseFactory.Create();
            _messageBus = new InMemoryMessageBus();
        }

        [Fact]
        public async Task Success()
        {
            //Arrange
            AccountId accountId = Guid.NewGuid();
            var sut = new Open(_database.Store, _messageBus);

            //Act
            var opened = await sut.ExecuteAsync(new OpenParams(accountId, 1_000_000m));

            //Assert
            Assert.True(opened);
            Assert.True(await _database.Store.ByIdAsync(accountId));
        }

        [Fact]
        public async Task SuccessWithNoInitialDeposit()
        {
            //Arrange
            AccountId accountId = Guid.NewGuid();
            var sut = new Open(_database.Store, _messageBus);

            //Act
            var opened = await sut.ExecuteAsync(new OpenParams(accountId, 0m));
            
            //Assert
            Assert.True(opened);
            var account = await _database.Store.ByIdAsync(accountId);
            Assert.True(account);
            Assert.Equal<decimal>(0m, account.Get().Balance);
        }

        [Fact]
        public async Task FailureEmptyAccountId()
        {
            //Arrange
            var accountId = AccountId.Empty;
            var sut = new Open(_database.Store, _messageBus);

            //Act
            var opened = await sut.ExecuteAsync(new OpenParams(accountId, 1_000_000m));

            //Assert
            Assert.False(opened);
            Assert.Equal(Errors.EmptyAccountId, opened.ErrorValue);
        }

        [Fact]
        public async Task FailureAccountAlreadyExists()
        {
            //Arrange
            AccountId accountId = Guid.NewGuid();
            await _database.Store.StoreAsync(Account.Open(accountId, 1m));
            
            var sut = new Open(_database.Store, _messageBus);

            //Act
            var opened = await sut.ExecuteAsync(new OpenParams(accountId, 1_000_000m));

            //Assert
            Assert.False(opened);
            Assert.Equal(CommandErrors.AccountAlreadyOpen, opened.ErrorValue);
            Assert.True(await _database.Store.ByIdAsync(accountId));
        }

        public void Dispose() =>
            DatabaseDisposer.Dispose(_database);
    }
}
